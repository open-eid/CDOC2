
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../ch03_container_format/" rel="prev"/>
<link href="../appendix_a_header_fbs/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.5.50" name="generator"/>
<title>Cryptographic details - CDOC2 System Documentation</title>
<link href="../../assets/stylesheets/main.a40c8224.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#cryptographic-details">6. 
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="CDOC2 System Documentation" class="md-header__button md-logo" data-md-component="logo" href="../.." title="CDOC2 System Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            CDOC2 System Documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Cryptographic details
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="CDOC2 System Documentation" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="CDOC2 System Documentation">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    CDOC2 System Documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Introduction
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Use Case Model
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Use Case Model
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../01_use_case_model/ch03_use_cases/">
<span class="md-ellipsis">
    Use Cases
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Protocol and Cryptography Specification
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Protocol and Cryptography Specification
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ch02_encryption_schemes/">
<span class="md-ellipsis">
    Encryption Schemes
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ch03_container_format/">
<span class="md-ellipsis">
    Container Format
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Cryptographic Details
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Cryptographic Details
  </span>
</a>
<nav aria-label="In this chapter:" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      In this chapter:
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#security-level-and-used-cryptographic-algorithms">
<span class="md-ellipsis">
      Security level and used cryptographic algorithms
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-derivation">
<span class="md-ellipsis">
      Key derivation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#descriptions-of-header-elements-and-kek-computation">
<span class="md-ellipsis">
      Descriptions of header elements and KEK computation
    </span>
</a>
<nav aria-label="Descriptions of header elements and KEK computation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#eccpublickeycapsule">
<span class="md-ellipsis">
      ECCPublicKeyCapsule
    </span>
</a>
<nav aria-label="ECCPublicKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-2-eccpublickeycapsule-elements">
<span class="md-ellipsis">
      Table 2. ECCPublicKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-eccpublickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (ECCPublicKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-eccpublickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (ECCPublicKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rsapublickeycapsule">
<span class="md-ellipsis">
      RSAPublicKeyCapsule
    </span>
</a>
<nav aria-label="RSAPublicKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-3-rsapublickeycapsule-elements">
<span class="md-ellipsis">
      Table 3. RSAPublicKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-rsapublickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (RSAPublicKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-rsapublickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (RSAPublicKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#keyservercapsule">
<span class="md-ellipsis">
      KeyServerCapsule
    </span>
</a>
<nav aria-label="KeyServerCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-4-keyservercapsule-elements">
<span class="md-ellipsis">
      Table 4. KeyServerCapsule elements
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#symmetrickeycapsule">
<span class="md-ellipsis">
      SymmetricKeyCapsule
    </span>
</a>
<nav aria-label="SymmetricKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-5-symmetrickeycapsule-elements">
<span class="md-ellipsis">
      Table 5. SymmetricKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-symmetrickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (SymmetricKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-symmetrickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (SymmetricKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#keysharescapsule">
<span class="md-ellipsis">
      KeySharesCapsule
    </span>
</a>
<nav aria-label="KeySharesCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-keysharescapsule">
<span class="md-ellipsis">
      KEK computation during encryption (KeySharesCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-keysharescapsule">
<span class="md-ellipsis">
      KEK computation during decryption (KeySharesCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fmk-encryption-and-decryption">
<span class="md-ellipsis">
      FMK encryption and decryption
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#header-authentication-code">
<span class="md-ellipsis">
      Header authentication code
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#payload-assembly-and-encryption">
<span class="md-ellipsis">
      Payload assembly and encryption
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_a_header_fbs/">
<span class="md-ellipsis">
    Appendix A: header.fbs
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_b_recipients_fbs/">
<span class="md-ellipsis">
    Appendix B: recipients.fbs
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_c_cdoc2-capsules/">
<span class="md-ellipsis">
    Appendix C: Capsules API
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_d_keylabel/">
<span class="md-ellipsis">
    Appendix D: KeyLabel field specification
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appendix_e_cdoc2-shares/">
<span class="md-ellipsis">
    Appendix E: Key Shares API
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    System Architecture
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            System Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch01_system_context/">
<span class="md-ellipsis">
    System Context
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch02_system_components/">
<span class="md-ellipsis">
    System Components
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch03_external_interfaces/">
<span class="md-ellipsis">
    External Interfaces
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch04_capsule_server/">
<span class="md-ellipsis">
    Capsule Server
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch05_shares_server/">
<span class="md-ellipsis">
    Shares Server
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../03_system_architecture/ch06_ID_authentication_protocol/">
<span class="md-ellipsis">
    Client authentication protocol
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Test Plan
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Test Plan
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../04_test_plan/test_plan/">
<span class="md-ellipsis">
    Capsule Server Test Plan
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    User Guides
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            User Guides
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../08_User_Guides/password_guide/">
<span class="md-ellipsis">
    Password Strength User Guide
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../08_User_Guides/parooli_juhend/">
<span class="md-ellipsis">
    Parooli juhend
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../08_User_Guides/container_storage_guide/">
<span class="md-ellipsis">
    CDOC2 Container Storage User Guide
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../08_User_Guides/konteineri_s%C3%A4ilitamise_juhend/">
<span class="md-ellipsis">
    CDOC2 konteineri säilitamise juhend
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../08_User_Guides/overview_diagrams/">
<span class="md-ellipsis">
    Overview diagrams
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Appendixes
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Appendixes
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../09_Appendixes/A1_Security_level/">
<span class="md-ellipsis">
    Appendix 1: Security level
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="In this chapter:" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      In this chapter:
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#security-level-and-used-cryptographic-algorithms">
<span class="md-ellipsis">
      Security level and used cryptographic algorithms
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-derivation">
<span class="md-ellipsis">
      Key derivation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#descriptions-of-header-elements-and-kek-computation">
<span class="md-ellipsis">
      Descriptions of header elements and KEK computation
    </span>
</a>
<nav aria-label="Descriptions of header elements and KEK computation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#eccpublickeycapsule">
<span class="md-ellipsis">
      ECCPublicKeyCapsule
    </span>
</a>
<nav aria-label="ECCPublicKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-2-eccpublickeycapsule-elements">
<span class="md-ellipsis">
      Table 2. ECCPublicKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-eccpublickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (ECCPublicKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-eccpublickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (ECCPublicKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rsapublickeycapsule">
<span class="md-ellipsis">
      RSAPublicKeyCapsule
    </span>
</a>
<nav aria-label="RSAPublicKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-3-rsapublickeycapsule-elements">
<span class="md-ellipsis">
      Table 3. RSAPublicKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-rsapublickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (RSAPublicKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-rsapublickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (RSAPublicKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#keyservercapsule">
<span class="md-ellipsis">
      KeyServerCapsule
    </span>
</a>
<nav aria-label="KeyServerCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-4-keyservercapsule-elements">
<span class="md-ellipsis">
      Table 4. KeyServerCapsule elements
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#symmetrickeycapsule">
<span class="md-ellipsis">
      SymmetricKeyCapsule
    </span>
</a>
<nav aria-label="SymmetricKeyCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#table-5-symmetrickeycapsule-elements">
<span class="md-ellipsis">
      Table 5. SymmetricKeyCapsule elements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-symmetrickeycapsule">
<span class="md-ellipsis">
      KEK computation during encryption (SymmetricKeyCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-symmetrickeycapsule">
<span class="md-ellipsis">
      KEK computation during decryption (SymmetricKeyCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#keysharescapsule">
<span class="md-ellipsis">
      KeySharesCapsule
    </span>
</a>
<nav aria-label="KeySharesCapsule" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-encryption-keysharescapsule">
<span class="md-ellipsis">
      KEK computation during encryption (KeySharesCapsule)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kek-computation-during-decryption-keysharescapsule">
<span class="md-ellipsis">
      KEK computation during decryption (KeySharesCapsule)
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fmk-encryption-and-decryption">
<span class="md-ellipsis">
      FMK encryption and decryption
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#header-authentication-code">
<span class="md-ellipsis">
      Header authentication code
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#payload-assembly-and-encryption">
<span class="md-ellipsis">
      Payload assembly and encryption
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="cryptographic-details"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.</span> Cryptographic details<a class="headerlink" href="#cryptographic-details" title="Permanent link">¶</a></h1>
<p>This section provides a detailed description of the cryptographic computations used with the CDOC2 format. Most of these computations are broader technological infrastructure-neutral, but some are specifically related to means of eID used in Estonia (above all, the ID-card). All such situations will be highlighted.</p>
<h2 id="security-level-and-used-cryptographic-algorithms"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.1</span> Security level and used cryptographic algorithms<a class="headerlink" href="#security-level-and-used-cryptographic-algorithms" title="Permanent link">¶</a></h2>
<p>Recent studies <a href="https://www.ecrypt.eu.org/csa/documents/D5.4-FinalAlgKeySizeProt.pdf">(1)</a>, <a href="https://doi.org/10.6028/NIST.SP.800-57pt1r5">(2)</a> give cause to assume that 128-bit security should be sufficiently secure even after 2031. This claim is also supported by a new study published in 2022 <a href="https://www.bsi.bund.de/SharedDocs/Downloads/EN/BSI/Publications/TechGuidelines/TG02102/BSI-TR-02102-1.pdf">(3)</a>. Based on these results, we use the following algorithms:</p>
<ul>
<li>HKDF-SHA-256</li>
<li>HMAC-SHA-256</li>
<li>ChaCha20-Poly1305</li>
</ul>
<p>The SHA2 hash function family is a long-standing standard. <a href="https://www.ria.ee/media/1473/download">Recent studies</a> show that the SHA2 hash functions are still secure and SHA-256 provides 128-bit security.</p>
<p>The HKDF key derivation function used here (see section <a href="#key-derivation">Key derivation</a> for more details) has been subject to an <a href="https://ia.cr/2010/264">in-depth security analysis</a>. The use of HKDF with a secure hash function is also recommended in the <a href="https://www.ecrypt.eu.org/csa/documents/D5.4-FinalAlgKeySizeProt.pdf">aforementioned study</a>.</p>
<p><a href="https://www.ria.ee/media/1473/download">A 128-bit key is sufficient for HMAC security</a>.</p>
<p>ChaCha20-Poly1305 is a secure (IND-CPA and INT-CTXT) authenticating encryption algorithm (see <a href="https://ia.cr/2014/613">e.g.</a>). As a stream cipher, <a href="https://www.ria.ee/media/1473/download">ChaCha20 also provides 256-bit security by itself</a>.</p>
<p>XOR encryption (one-time pad) providing 256-bit security is used for FMK encryption.</p>
<p>Key lengths used for symmetric keys:</p>
<ul>
<li>FMK – 256 bits.</li>
<li>HHK – 256 bits.</li>
<li>CEK – depends on the payload encryption algorithm used, 256 bits for ChaCha20-Poly1305.</li>
<li>KEK – depends on the FMK encryption algorithm used, 256 bits for XOR.</li>
</ul>
<h2 id="key-derivation"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.2</span> Key derivation<a class="headerlink" href="#key-derivation" title="Permanent link">¶</a></h2>
<p>For key derivation, the CDOC2 format utilizes the HKDF key derivation function, codified as <a href="https://rfc-editor.org/rfc/rfc5869.txt">IETF RFC 5869</a>.</p>
<p>RFC 5869 defines two key derivation functions: <code>HKDF-Extrac</code>t and <code>HKDF-Expand</code>, the use of which will be discussed below. Hereafter, these functions will be referenced using the shorthands <code>Extract</code> and <code>Expand</code>.</p>
<p>In all cases, key derivation is carried out using the SHA-256 hash function, meaning that the functions return a 256-bit value.
To be used as input in functions, all textual constants must be UTF-8 encoded (in the present case, cryptographic functions take byte arrays and integers as input), quotation marks used in the specification are not part of the strings.</p>
<p>Public symmetric keys are derived as follows.</p>
<p><strong>File Master Key, FMK</strong></p>
<p><em>FMK ← Extract(”CDOC20salt”, random)</em></p>
<p>Where <em>CDOC20salt</em> is a constant string and <em>random</em> is an at least 256-bit value generated using a cryptographically secure random number generator (CSPRNG).</p>
<p><strong>Content Encryption Key, CEK</strong></p>
<p><em>CEK ← Expand(FMK, ”CDOC20cek”, L<sub><sub>octets</sub></sub>)</em></p>
<p>L<sub>octets</sub> defines the output length of the Expand function in bytes and must be equal to the key length of the used symmetric encryption algorithm (see section <a href="#payload-assembly-and-encryption">Payload assembly and encryption</a>).</p>
<p><strong>Header HMAC Key, HHK</strong></p>
<p><em>HHK ← Expand(FMK, ”CDOC20hmac”, 32<sub><sub>octets</sub></sub>)</em></p>
<p>Note that the length of the HHK derived in this manner is 256 bits, i.e. equal to the output length of the used SHA-256 hash algorithm. This is based on the recommendations presented in the <a href="https://rfc-editor.org/rfc/rfc2104.txt">HMAC standard</a>.</p>
<p><strong>Key Encryption Key, KEK</strong></p>
<p>KEK derivation is immediately tied to the used recipient type, and is described in connection with the relevant format elements:</p>
<ul>
<li>ECCPublicKeyCapsule – section <a href="#eccpublickeycapsule">ECCPublicKeyCapsule</a>.</li>
<li>RSAPublicKeyCapsule – section <a href="#rsapublickeycapsule">RSAPublicKeyCapsule</a>.</li>
<li>KeyServerCapsule – section <a href="#keyservercapsule">KeyServerCapsule</a>.</li>
<li>SymmetricKeyCapsule – section <a href="#symmetrickeycapsule">SymmetricKeyCapsule</a>.</li>
<li>KeySharesCapsule - section <a href="#keysharescapsule">KeySharesCapsule</a>.</li>
</ul>
<h2 id="descriptions-of-header-elements-and-kek-computation"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3</span> Descriptions of header elements and KEK computation<a class="headerlink" href="#descriptions-of-header-elements-and-kek-computation" title="Permanent link">¶</a></h2>
<p>The abstracted structure of the header is described in section <a href="../ch03_container_format/#cdoc2-container-format">CDOC2 container format</a>. Fields are described in the abstracted structure using primitive data types. The following section describes how to compute the fields and translate values to the primitive data type form.</p>
<p>Key Encryption Key (KEK) computation depends on recipient type. Below, KEK computation is described with reference to each specific recipient type.</p>
<h3 id="eccpublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.1</span> ECCPublicKeyCapsule<a class="headerlink" href="#eccpublickeycapsule" title="Permanent link">¶</a></h3>
<p><code>ECCPublicKeyCapsule</code> (see <a href="#table-2-eccpublickeycapsule-elements">table 2</a>) refers to a recipient identified by their ECC public key. The CDOC2 format supports the use of any public key generated on a <em>secp384r1</em> elliptic curve as the recipient. For example, the key can be the public key of the Estonian ID-card authentication key pair.
For the <em>secp384r1</em> curve, the TLS 1.3 encoding used for elliptic curve points is identical to the encoding used in CDOC 1.0.
The <code>ECCPublicKeyCapsule</code> structure corresponds to the capsule capsi in the sense of the protocols presented in sections <a href="../ch02_encryption_schemes/#direct-key-agreement-based-ecdh">Direct key agreement-based ECDH</a> and <a href="../ch02_encryption_schemes/#key-server-based-ecdh">Capsule server-based ECDH</a>.</p>
<h4 id="table-2-eccpublickeycapsule-elements"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.1.1</span> Table 2. <em>ECCPublicKeyCapsule</em> elements<a class="headerlink" href="#table-2-eccpublickeycapsule-elements" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Contents</th>
<th>Encoding</th>
</tr>
</thead>
<tbody>
<tr>
<td>Curve</td>
<td>Elliptic curve used; currently only <em>secp384r1</em>.</td>
<td>Based on the format used; see scheme description.</td>
</tr>
<tr>
<td>RecipientPublicKey</td>
<td>Recipient’s public key, e.g. ID-card key pair 1 public key.</td>
<td>Public key is encoded following <a href="https://rfc-editor.org/rfc/rfc8446.txt">TLS 1.3 rules, section 4.2.8.2</a>.</td>
</tr>
<tr>
<td>SenderPublicKey</td>
<td>Sender ephemeral (short-lived or even one-time) key pair public key</td>
<td>Public key is encoded following <a href="https://rfc-editor.org/rfc/rfc8446.txt">TLS 1.3 rules, section 4.2.8.2</a>.</td>
</tr>
</tbody>
</table>
<p>The sender computes the KEK using the secret key of the ephemeral key pair they have generated, and the recipient’s public key, using the elliptic-curve Diffie-Hellman key agreement protocol (ECDH), and passes the result to the specified key derivation function. The recipient performs a similar computation using the sender’s ephemeral public key and the ID-card authentication key pair. Details of the computations are provided below.</p>
<p>The sender’s ephemeral key pair is anonymous, i.e. not tied to the sender’s public identity in any way.</p>
<p>In case there are multiple recipients, the sender can use the same ephemeral key pair over a single CDOC container.</p>
<p>The sender’s ephemeral key pair consists of a public and a secret key:</p>
<div class="arithmatex">\[(pk_{eph}, sk_{eph})\]</div>
<p>The recipient holds their ID-card authentication key pair public key <em>pkrec</em> (assuming here that the recipient’s private key is not immediately accessible).</p>
<p>This key is also accessible to the sender. Mechanisms for the dissemination of the recipient's public key are outside the scope of this specification.</p>
<h4 id="kek-computation-during-encryption-eccpublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.1.2</span> KEK computation during encryption (ECCPublicKeyCapsule)<a class="headerlink" href="#kek-computation-during-encryption-eccpublickeycapsule" title="Permanent link">¶</a></h4>
<p>The shared ECDH secret is computed by the sender as follows:</p>
<div class="arithmatex">\[ S_{ecdh} ← (s_{keph} · pk_{rec})_x \]</div>
<p>i.e. the shared secret is the elliptic curve x-coordinate computed in this manner. The shared secret is encoded as a big-endian byte array, the length of which in full bytes corresponds to the modulus length of the used elliptic curve in full bytes. For example, the modulus length of secp384r1 is 48 bytes.</p>
<p>KEK is computed from the shared secret as follows:</p>
<div class="arithmatex">\[ KEK_{pm} ← Extract(”CDOC20kekpremaster”, S_{ecdh}) \]</div>
<div class="arithmatex">\[ KEK ← Expand(KEK_{pm}, ”CDOC20kek” ∥ algId ∥ pk_{rec} ∥ pk_{eph}, L_{&lt;sub&gt;octets&lt;/sub&gt;}) \]</div>
<p><em>algId</em> is the identifier of the cryptographic algorithm used for the encryption of the FMK defined as a string corresponding to the field <em>Recipient.FMKEncryptionMethod</em> (section <a href="#fmk-encryption-and-decryption">FMK encryption and decryption</a>).</p>
<p><em>L<sub><sub>octets</sub></sub></em> defines the output length of the <code>Expand</code> function in bytes and is defined by the symmetric encryption algorithm used for FMK encryption.</p>
<h4 id="kek-computation-during-decryption-eccpublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.1.3</span> KEK computation during decryption (ECCPublicKeyCapsule)<a class="headerlink" href="#kek-computation-during-decryption-eccpublickeycapsule" title="Permanent link">¶</a></h4>
<p>The Estonian ID-card supports the use of an authentication key pair as one of the ECDH parties.
This functionality can advantageously be used through the PKCS#11 <code>C_DERIVEKEY</code> function, employing the <code>CKM_ECDH1_DERIVE</code> mechanism.
Key derivation can also be performed using the Windows <code>NCryptSecretAgreement</code> and <code>NCryptDeriveKey</code> encryption functions. <code>NCryptSecretAgreement</code> computes the <em>Secdh</em> and <code>NCryptDeriveKey</code> computes the <em>KEKpm</em>. <code>NCryptDeriveKey</code> parameters must be set as follows:</p>
<ul>
<li><code>hSharedSecret</code> – handle returned by <code>NCryptSecretAgreement</code>.</li>
<li><code>pwszKDF</code> – the constant BCRYPT_KDF_HMAC.</li>
<li><code>pParameterList</code> – algorithm parameters:</li>
<li><code>KDF_HASH_ALGORITHM</code> – the constant <code>BCRYPT_SHA256_ALGORITHM</code>.</li>
<li><code>KDF_HMAC_KEY</code> – the constant <code>CDOC20kekpremaster</code>.</li>
<li><code>KDF_SECRET_PREPEND</code> – parameter omitted.</li>
<li><code>KDF_SECRET_APPEND</code> – parameter omitted.</li>
</ul>
<p>All ID-cards used today should be able to validate elliptic curve points used as input in ECDH key derivation, but additional validation may be implemented in software supporting the CDOC format to provide more user-friendly error management.</p>
<p>In order to validate whether the point <em>Q = (x, y)</em> is located on the curve, it must be verified whether <em>x</em> and <em>y</em> fall in the interval [0…<em>p</em> – 1], whether they satisfy the curve equation, and whether the point falls in the correct subgroup. For example, the formula for the curve P-384 can be presented as</p>
<div class="arithmatex">\[ y^2 ≡ x^3 - 3x+b\bmod p\; \]</div>
<p>It must also be verified that <em>nQ</em> = 0 and <em>Q</em> != 0. The constants <em>b</em>, <em>p</em>, and <em>n</em> are described in the <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf">Digital Signature Standard</a>.
The <code>C_DERIVEKEY</code> function takes the sender’s ephemeral public key <em>pkeph</em> and a reference to the corresponding ID-card key pair (<em>pkrec</em>, <em>skrec</em>) as inputs. The recipient computes</p>
<div class="arithmatex">\[S_{ecdh}' \leftarrow (sk_{rec}\cdot pk_{eph})_{x}\;\]</div>
<p>Thanks to the algebraic properties of the elliptic curve,
<span class="arithmatex">\(S_{ecdh}=S_{ecdh}'\)</span>.</p>
<p>This shared secret must be used to compute KEK as described above with reference to encryption.</p>
<h3 id="rsapublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.2</span> RSAPublicKeyCapsule<a class="headerlink" href="#rsapublickeycapsule" title="Permanent link">¶</a></h3>
<p><em>RSAPublicKeyCapsule</em> (see <a href="#table-3-rsapublickeycapsule-elements">table 3</a>) refers to a recipient identified by their RSA public key.
The structure <em>RSAPublicKeyCapsule</em> corresponds to the capsule <em>capsi</em> in the sense of the protocols presented in sections <a href="../ch02_encryption_schemes/#direct-key-agreement-based-ecdh">Direct key agreement-based ECDH</a> and <a href="../ch02_encryption_schemes/#key-server-based-ecdh">Capsule server-based ECDH</a>.</p>
<p>The sender generates a random KEK and encrypts it using the recipient’s RSA public key with OAEP padding. The recipient decrypts the encrypted KEK using their RSA private key. Details of the computations are provided below.</p>
<p>The recipient’s public key is also accessible to the sender. Mechanisms for the dissemination of the recipient's public key are outside the scope of this specification.</p>
<h4 id="table-3-rsapublickeycapsule-elements"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.2.1</span> Table 3. RSAPublicKeyCapsule elements<a class="headerlink" href="#table-3-rsapublickeycapsule-elements" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Contents</th>
<th>Encoding</th>
</tr>
</thead>
<tbody>
<tr>
<td>RecipientPublicKey</td>
<td>RSA public key</td>
<td>Value: DER encoding of the ASN.1 structure <em>RSAPublicKey</em> (see <a href="https://www.rfc-editor.org/rfc/rfc8017">section A.1.1</a>)</td>
</tr>
<tr>
<td>EncryptedKEK</td>
<td>KEK encrypted using recipient’s public key</td>
<td>XXX</td>
</tr>
</tbody>
</table>
<h4 id="kek-computation-during-encryption-rsapublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.2.2</span> KEK computation during encryption (RSAPublicKeyCapsule)<a class="headerlink" href="#kek-computation-during-encryption-rsapublickeycapsule" title="Permanent link">¶</a></h4>
<p>The symmetric encryption algorithm used for the encryption of the FKM defines the KEK length <em>L<sub>octets</sub></em>. The sender generates a random number KEK with a length of <em>L<sub>octets</sub></em>.</p>
<p>For the encryption of the KEK, the sender uses the RSA-OAEP (see <a href="https://www.rfc-editor.org/rfc/rfc8017">section 7.1</a>) encryption function. RSA-OAEP has three input parameters (see <a href="https://www.rfc-editor.org/rfc/rfc8017">section A.2.1</a>):
    • <code>hashAlgorithm</code> – hash function used by the algorithm. We use the SHA-256 hash function (<code>id-sha256</code>).
    • <code>maskGenAlgorithm</code> – mask generation function used by the algorithm. We use the MGF1 function (<code>id-mgf1</code>), parametrized by the SHA-256 hash function.
    • <code>pSourceAlgorithm</code> – label source function. We use an empty label (<code>pSpecified Empty</code>).</p>
<h4 id="kek-computation-during-decryption-rsapublickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.2.3</span> KEK computation during decryption (RSAPublicKeyCapsule)<a class="headerlink" href="#kek-computation-during-decryption-rsapublickeycapsule" title="Permanent link">¶</a></h4>
<p>The recipient decrypts the encrypted KEK using their private key and the same parameters as were used for encryption.</p>
<h3 id="keyservercapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.3</span> KeyServerCapsule<a class="headerlink" href="#keyservercapsule" title="Permanent link">¶</a></h3>
<p>The Capsule Server described by the <code>KeyServerCapsule</code> structure (see <a href="#table-4-keyservercapsule-elements">table 4</a>) returns the following structures which are handled as described in the referenced sections:</p>
<ul>
<li><em>ECCPublicKeyCapsule</em>: section <a href="#eccpublickeycapsule">ECCPublicKeyCapsule</a>.</li>
<li><em>RSAPublicKeyCapsule</em>: section <a href="#rsapublickeycapsule">RSAPublicKeyCapsule</a>.</li>
</ul>
<p>The details of using <em>KeyServerCapsule</em> are described in section <a href="../../03_system_architecture/ch04_capsule_server/#key-server">Capsule server</a>.</p>
<h4 id="table-4-keyservercapsule-elements"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.3.1</span> Table 4. KeyServerCapsule elements<a class="headerlink" href="#table-4-keyservercapsule-elements" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Contents</th>
<th>Encoding</th>
</tr>
</thead>
<tbody>
<tr>
<td>RecipientKey</td>
<td>Information on recipient key used by the recipient for authentication with the capsule server.</td>
<td>-</td>
</tr>
<tr>
<td>KeyServerID</td>
<td>Capsule server identifier.</td>
<td>UTF-8 string assigned by the software trust anchor configuration, see section <a href="../../03_system_architecture/ch04_capsule_server/#server-identification-and-trust">Server identification and trust</a>.</td>
</tr>
<tr>
<td>TransactionID</td>
<td>Transaction identifier</td>
<td>UTF-8 string assigned by the capsule server</td>
</tr>
</tbody>
</table>
<h3 id="symmetrickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.4</span> SymmetricKeyCapsule<a class="headerlink" href="#symmetrickeycapsule" title="Permanent link">¶</a></h3>
<p><em>SymmetricKeyCapsule</em> (see <a href="#table-5-symmetrickeycapsule-elements">table 5</a>) refers to a recipient identified by a key label.
In this scheme, the sender and recipient are either the same person (use case: storage cryptography) or have previously exchanged a symmetric secret key outside the system (use case: transport cryptography).
In both cases, both the sender and the recipient holds the same secret key, identified by a key label. The specification does not limit the selection of the label in any way.</p>
<h4 id="table-5-symmetrickeycapsule-elements"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.4.1</span> Table 5. SymmetricKeyCapsule elements<a class="headerlink" href="#table-5-symmetrickeycapsule-elements" title="Permanent link">¶</a></h4>
<table>
<thead>
<tr>
<th>Field</th>
<th>Contents</th>
<th>Encoding</th>
</tr>
</thead>
<tbody>
<tr>
<td>Salt</td>
<td>Random number generated by the sender, used as input for the HKDF-Extract function in KEK derivation</td>
<td>Byte array</td>
</tr>
</tbody>
</table>
<h4 id="kek-computation-during-encryption-symmetrickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.4.2</span> KEK computation during encryption (SymmetricKeyCapsule)<a class="headerlink" href="#kek-computation-during-encryption-symmetrickeycapsule" title="Permanent link">¶</a></h4>
<p>The sender holds the symmetric key <em>sym</em> labelled <em>label</em>. The sender generates the random number <em>salt</em>. The purpose of this number is to ensure the generation of a new KEK even when reusing the key <em>sym</em>. Since no practical upper limit can be set for the reuse of the key, the length of <em>salt</em> is chosen with a significant margin, i.e. 256 bits.
KEK is computed from the symmetric key and the generated random number as follows:</p>
<div class="arithmatex">\[ KEK_{pm} \leftarrow Extract(salt, sym) \]</div>
<div class="arithmatex">\[ KEK     \leftarrow Expand(KEK_{pm}, "CDOC20kek" \parallel algId \parallel label, L_{octets})
\]</div>
<p>Where <em>algId</em> is the identifier of the encryption algorithm used for the encryption of the FMK as a string, set as <code>Recipient.FMKEncryptionMethod</code> (section <a href="#fmk-encryption-and-decryption">FMK encryption and decryption</a>).</p>
<p><em>L<sub>octets</sub></em> defines the output length of the <code>Expand</code> function in bytes, determined by the symmetric encryption algorithm used for the encryption of the FMK.</p>
<h4 id="kek-computation-during-decryption-symmetrickeycapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.4.3</span> KEK computation during decryption (SymmetricKeyCapsule)<a class="headerlink" href="#kek-computation-during-decryption-symmetrickeycapsule" title="Permanent link">¶</a></h4>
<p>The recipient holds the symmetric key <em>sym</em> labelled <em>label</em>. The <em>Salt</em> field of the <em>SymmetricKeyCapsule</em> structure provides the random number <em>salt</em> generated by the sender.</p>
<p>This information is used for computing the KEK just as described above with reference to encryption.</p>
<h3 id="keysharescapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.5</span> KeySharesCapsule<a class="headerlink" href="#keysharescapsule" title="Permanent link">¶</a></h3>
<p>Capsule type <code>KeySharesCapsule</code> refers to a situation, when the encryption/decryption key material is split between multiple CCS servers. The corresponding encryption/decryption scheme is <a href="../ch02_encryption_schemes/#sc05-encryption-scheme-for-recipients-with-pre-shared-symmetric-secret">SC07</a>. In such cases, the KEK is not derived using any of the key establishment algorithms, but generated from CSRNG.</p>
<h4 id="kek-computation-during-encryption-keysharescapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.5.1</span> KEK computation during encryption (KeySharesCapsule)<a class="headerlink" href="#kek-computation-during-encryption-keysharescapsule" title="Permanent link">¶</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Constants: </span>

<span class="c1">#identifier of the method, which is used to encrypt the plaintext FMK value:</span>
<span class="n">FMKEncryptionMethod</span> <span class="o">=</span> <span class="s2">"XOR"</span> 

<span class="c1"># length of KEK_i in octets, so that it matches the length of FMK for the XOR() algorithm</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">32</span> 

<span class="c1"># Recipient identifier: </span>
<span class="n">RecipientInfo_i</span> <span class="o">=</span> <span class="s2">"etsi/PNOEE-48010010101"</span>

<span class="c1"># KEK_i computation: </span>
<span class="n">KeyMaterialSalt_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">KeyMaterial_i</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="n">KEK_i_pm</span> <span class="o">=</span> <span class="n">HKDF_Extract</span><span class="p">(</span><span class="n">KeyMaterialSalt_i</span><span class="p">,</span> <span class="n">KeyMaterial_i</span><span class="p">)</span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">HKDF_Expand</span><span class="p">(</span><span class="n">KEK_i_pm</span><span class="p">,</span> <span class="s2">"CDOC2kek"</span> <span class="o">+</span> <span class="n">FMKEncryptionMethod</span> <span class="o">+</span> <span class="n">RecipientInfo_i</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
<span class="c1"># Splitting KEK_i into shares</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
   <span class="n">KEK_i_share_j</span> <span class="o">=</span> <span class="n">CSRNG</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> 
<span class="n">KEK_i_share_1</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i</span><span class="p">,</span> <span class="n">KEK_i_share_2</span><span class="p">,</span> <span class="n">KEK_i_share_3</span><span class="p">,</span><span class="o">...</span><span class="p">,</span> <span class="n">KEK_i_share_n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>The reason for including <code>FMKEncryptionMethod</code> and <code>RecipientInfo_i</code> under the <code>HKDF_Expand()</code> function is that this ensures further differences of KEKs between multiple encryption sessions and may prevent some sort of replay attack, when the key is taken out of one context and submitted to another context.</p>
<h4 id="kek-computation-during-decryption-keysharescapsule"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.3.5.2</span> KEK computation during decryption (KeySharesCapsule)<a class="headerlink" href="#kek-computation-during-decryption-keysharescapsule" title="Permanent link">¶</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># KEK_i computation: </span>
<span class="n">KEK_i</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">KEK_i_share_1</span><span class="p">,</span> <span class="n">KEK_i_share_2</span><span class="p">,</span> <span class="n">KEK_i_share_3</span><span class="p">,</span><span class="o">...</span><span class="p">,</span> <span class="n">KEK_i_share_n</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="fmk-encryption-and-decryption"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.4</span> FMK encryption and decryption<a class="headerlink" href="#fmk-encryption-and-decryption" title="Permanent link">¶</a></h2>
<p>The FMK is encrypted using the XOR operation.</p>
<p>The FMK assumes that the KEK and FMK are of equal length, which can be ensured by using the HKDF key derivation method.</p>
<p>For FMK encryption, the XOR operation is applied bitwise to the corresponding bits in the FMK and the KEK.</p>
<p>For decryption, the XOR operation is applied bitwise to the corresponding bits in the cryptogram and the KEK.</p>
<h2 id="header-authentication-code"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.5</span> Header authentication code<a class="headerlink" href="#header-authentication-code" title="Permanent link">¶</a></h2>
<p>The header authentication code is computed with the <a href="https://rfc-editor.org/rfc/rfc2104.txt">HMAC algorithm</a>, using the SHA-256 hash function.</p>
<p>The HHK (see section <a href="#key-derivation">Key derivation</a>) is used as the key.</p>
<p>HHK length must be at least equal to the output length of the used hash function, i.e. 256 bits.</p>
<div class="arithmatex">\[ HMACValue_{header} \leftarrow HMAC_{SHA-256}(HHK, header) , \]</div>
<p>where <em>header</em> is the serialized header in the form it is added to the envelope.</p>
<p>Validation of the message authentication code requires computing the HHK from the parsed header, then computing a message authentication code for the serialized header read from the container and comparing the computed code with the message authentication code read from the container – the two values must be identical.</p>
<h2 id="payload-assembly-and-encryption"><span class="enumerate-headings-plugin enumerate-heading-plugin">6.6</span> Payload assembly and encryption<a class="headerlink" href="#payload-assembly-and-encryption" title="Permanent link">¶</a></h2>
<p>NOTE: The section below describes the encryption of the payload as a byte array. The assembly of encrypted files into a single byte array is described in section <a href="../ch03_container_format/#unencrypted-payload">Unencrypted payload</a>.</p>
<p>For payload encryption, <a href="https://www.rfc-editor.org/info/rfc8439">ChaCha20-Poly1305 AEAD encryption</a> is used with the following parameters:</p>
<ul>
<li>Key length: 256 bits</li>
<li>Nonce length: 96 bits</li>
<li>Authentication label length: 128 bits</li>
</ul>
<p>CEK is used as the key.</p>
<p>The nonce (<em>nonce</em>) is always generated afresh, using a cryptographically secure random number generator (CSPRNG).</p>
<p>Additional data (<em>additionalData</em>) comprises a predetermined UTF-8 encoded string, the serialized header, and the header message authentication code.</p>
<div class="arithmatex">\[  additionalData \leftarrow "CDOC20payload" \parallel header \parallel headerHMAC \]</div>
<p>Payload (<em>payLoad</em>) encryption is performed using the encryption function below, with an output length of plaintext payload length plus authentication label length.</p>
<div class="arithmatex">\[ encryptedPayload \leftarrow encrypt_{cc20p1305}(CEK, nonce, payLoad, additionalData) \]</div>
<p>Decryption of the encrypted payload is performed using the decryption function below.</p>
<div class="arithmatex">\[ payload \leftarrow decrypt_{cc20p1305}(CEK, nonce, encryptedPayLoad, additionalData) \]</div>
<p>When processing the payload in streaming mode, the plaintext will be handled before the decryption function has validated the authentication label. Requirements for plaintext processing and error handling are detailed in section <a href="../ch03_container_format/#requirements-for-payload-unpacking">Requirements for payload unpacking</a>. It is critical to delete all files if authentication label validation fails.</p>
<p>The encrypted payload is serialized along with the nonce, as the nonce has to be transmitted to the recipient.</p>
<div class="arithmatex">\[ serializedPayload \leftarrow nonce \parallel encryptedPayLoad \]</div>
<p>In the case of the format envelope, payload means an encrypted and serialized payload (<em>serializedPayload</em>). Nonce and other details have not been explicated in the description of the envelope as they depend on the encryption method employed.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Container Format" class="md-footer__link md-footer__link--prev" href="../ch03_container_format/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Container Format
              </div>
</div>
</a>
<a aria-label="Next: Appendix A: header.fbs" class="md-footer__link md-footer__link--next" href="../appendix_a_header_fbs/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Appendix A: header.fbs
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.footer", "navigation.expand", "content.tooltips", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
<script src="../../javascripts/katex.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
</body>
</html>